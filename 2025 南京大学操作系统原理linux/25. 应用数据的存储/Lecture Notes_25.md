# 2025 å—äº¬å¤§å­¦æ“ä½œç³»ç»ŸåŸç†

> æ“ä½œç³»ç»ŸåŸç†è¯¾ç¨‹å­¦ä¹ ç¬”è®°
> åŒ…æ‹¬*è½¯ä»¶å®‰è£…ï¼Œç¯å¢ƒé…ç½®ï¼Œè¿è¡Œå‘½ä»¤ï¼Œä¸“æœ‰åè¯ï¼ŒåŸºæœ¬æ¦‚å¿µ*ç­‰ã€‚

[toc]

[PPT](https://jyywiki.cn/OS/2025/lect25.md)

---
## 25. åº”ç”¨æ•°æ®çš„å­˜å‚¨
æ“ä½œç³»ç»Ÿä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæä¾›äº†å¤šç§æŒä¹…åŒ–æ§åˆ¶çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬ fsync ç³»åˆ— APIã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°æ›´ä¸ºå¯é ã€æ›´ä¸ºå¯ç”¨çš„æ•°æ®å­˜å‚¨æ–¹æ³•ã€‚

**æœ¬è®²å†…å®¹**ï¼šæ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡åŸç†ä¸å®ç°æŠ€æœ¯ã€‚

```bash
../../mosaic/mosaic.py -c file-write.py | ../../mosaic/collect.py
```

## Review & Comments
**ä¸Šæ¬¡è§†é¢‘ç¿»è½¦äº†**
**æŒä¹…æ•°æ®çš„å¯é æ€§**
- RAID å’Œäº‘å­˜å‚¨ç³»ç»Ÿ

**å´©æºƒä¸€è‡´æ€§**
- æ•°æ®ç»“æ„çš„ multi-write åœ¨å´©æºƒæ—¶å¯¼è‡´ä¸ä¸€è‡´çŠ¶æ€
- é€šè¿‡ flush æœºåˆ¶å’Œ journaling å®ç°å´©æºƒä¸€è‡´æ€§

---
**æ–‡ä»¶ç³»ç»Ÿ API åˆ°æ­¤ç»“æŸ**
**æ–‡ä»¶ (æ•°æ® & å…ƒæ•°æ®) ç®¡ç†**
- open, read, write, close, stat, chmod, chown, fsetxattr/fgetxattr, ftruncate, ...

**ç›®å½•æ ‘ç®¡ç†**
- mount, mkdir, readdir, link, symlink, unlink, rename, chdir, ...

**ä¸€è‡´æ€§ç®¡ç†**
- sync > syncfs > fsync > fdatasync

**å…¶ä»–ç›¸å…³çš„æ“ä½œç³»ç»Ÿ API**
- flock, mmap, ...

```bash
a.txt.new()
# rm a.txt # linuxä¸éœ€è¦rm,ä¼šcrash, ç›®å½•ç»“æ„æ›´é‡è¦ï¼ŒåŸæ•°æ®å†™å…¥ä¼˜å…ˆ
rename a.txt.new a.txt
```

---
**æš—è—æ€æœºçš„ç³»ç»Ÿè°ƒç”¨**
**å¤æ‚æ•°æ®ç»“æ„éƒ½æ¶‰åŠ multiple writes**
```c
write(fd, buf, 4096); // append
```
- åˆ†é…æ•°æ®å—: bwrite(d-bitmap)
- å†™å…¥æ•°æ®å—: bwrite(data)
- æ›´æ–° size, time, index, ...: bwrite(inode)

```bash
cd ~/.ssh
ls -l
cat id_rsa.pub

man 2 sync

time sync
touch ~/a.txt; time sync
```

```bash
tree .git | less
```

---
## 25.1 å…³ç³»ä»£æ•°ã€SQL å’Œæ•°æ®åº“ ğŸŒ¶ï¸
**ä»€ä¹ˆæ˜¯ â€œåº”ç”¨ç¨‹åºâ€ï¼Ÿ**
> è½¯ä»¶æ˜¯ç‰©ç†ä¸–ç•Œè¿‡ç¨‹åœ¨ä¿¡æ¯ä¸–ç•Œä¸­çš„æŠ•å½±ã€‚

- è½¯ä»¶å¤©ç”Ÿæœ‰ persist data çš„éœ€æ±‚
    - ä¸ªäººä¿¡æ¯ (å­¦ç±â€¦â€¦)
    - è®¢å•
    - æ—¥å¿— (æ”¯ä»˜è®°å½•ã€ç»´æŠ¤è®°å½•â€¦â€¦)
    - â€¦â€¦
- è®©æˆ‘ä»¬ â€œé‡æ–°å®ç°â€ æ•™åŠ¡ç³»ç»Ÿå§ï¼
    - å…ˆè®©æˆ‘ä»¬å» ehall.nju.edu.cn çœ‹ä¸€çœ¼

**ä¿å­˜åº”ç”¨æ•°æ® (1)**
**åœ¨æ–‡ä»¶ (è™šæ‹Ÿç£ç›˜) ä¸Šæ„å»ºæ•°æ®ç»“æ„**
- å°±åƒ ELF, BMP, ...
```c
struct superblock {
    struct student *s;
    struct course *c; 
}
struct student { char stuid[16]; ...  };
struct course  { char cid[16]; ...  }
```
- éœ€æ±‚ï¼šexpel(s); enroll(s, c); ...
    - åº”ç”¨ç³»ç»Ÿå®ç°ç¿»è¯‘æˆ read, write, lseek ç³»ç»Ÿè°ƒç”¨
    - (ä¹Ÿå¯ä»¥ mmap/msync)

**å…¸å‹çš„åº”ç”¨æ•°æ®ç»“æ„**
**æ¸¸æˆæ˜¯ä¸€ä¸ªçŠ¶æ€æœº (Everything is a state machine)**

å›æ”¾å·¥å…·ï¼šBWChart

**ä¿å­˜åº”ç”¨æ•°æ® (2)**
**åˆ©ç”¨ç›®å½•æ ‘**
- UNIX ä¸–ç•Œä¸­çš„å·¥å…·éƒ½èƒ½ç”¨äº†ï¼šfind, grep, ...
    - å¦‚ä½•å…³è”å­¦ç”Ÿå’Œé€‰è¯¾/æˆç»©ï¼ŸCopy? Symlink?
    - å¦‚ä½•å®ç°å¹¶å‘è®¿é—® (å’Œ crash) çš„ consistency?
> M7 HTTP

ä¸ªäºº/å›¢é˜Ÿ-->å›½æ°‘çº§

**æˆ‘ä»¬éœ€è¦çš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ**
**Concurrency (Parallelism)**
- å…¨æ ¡ä¸€èµ·é€‰è¯¾ï¼Œç³»ç»Ÿä¸èƒ½å´© (ä¸èƒ½ä¸€æŠŠå¤§é”ä¿å¹³å®‰)

**Persistence (Crash Consistent)**
- ç³»ç»Ÿæ•…éšœï¼Œæ•°æ®ä¸èƒ½ä¸¢

**Atomicity ğŸ˜Š**
```c
enroll_list = random_enroll()
with AllOrNothing():
    for id in enroll_list:
        Path(f'enrollment/{id}.md').write_text('y')
    ...
```
`man 2 flock`

**Relational Database (å…³ç³»å‹æ•°æ®åº“)**
**ä¸€ä¸ª surprisingly simple çš„æ¨¡å‹**
- A relational model of data for large shared data banks
    - Edgar F. Codd: 1981 Turing Award Winner
    - â€œFuture users of large data banks must be protected from having to know how the data is organized in the machine.â€
        - æˆ‘åšäº†å¾ˆå¤šå¹´ program synthesis; ä½†å‡¡æ˜¯ end-user çš„ï¼Œæœ€åçš„è®¾è®¡ç†å¿µéƒ½ä¼šå›åˆ°è¿™ä¸€ç¯‡ paper
- Everything is a table
    - æ¯è¡Œä¸€ä¸ªå¯¹è±¡ï¼›å¯¹è±¡å¯ä»¥ç”¨ id ç´¢å¼•å…¶ä»–å¯¹è±¡

**å…³ç³»æ•°æ®åº“æ¨¡å‹**
**â€œå¯¹è±¡å’ŒæŒ‡é’ˆâ€**

**å…³ç³»æ•°æ®åº“æŸ¥è¯¢ï¼šæŒ‡é’ˆ â€œé…å¯¹â€**
```sql
SELECT Courses.Title
FROM Student 
JOIN Takes_Course
    ON Student.ID = Takes_Course.ID  -- Key
JOIN Courses
    ON Takes_Course.ClassID = Courses.ClassID  -- Key
WHERE Student.Name LIKE 'å¼ %'
```

- [ ] JOIN

- [ ] DBA æ•°æ®åº“ç®¡ç†å‘˜

**æ•°æ®åº“ç³»ç»Ÿå¼€å¯è½¯ä»¶çš„æ–°æ—¶ä»£**
**â€œACIDâ€ æ•°æ®åº“**
- A (Atomicity), C (Consistency), I (Isolation), D (Durability)
    - Strong serializability: æŸ¥è¯¢ç»“æœ â€œæŒ‰ç…§æŸç§é¡ºåºå®Œæˆâ€
    - Strong crash consistency: ç³»ç»Ÿ crash ä¹Ÿä¸ä¼šæŸåæˆ–ä¸¢å¤±

**æ”¯æŒä»»æ„é•¿ (å…è®¸æ··åˆä»»æ„è®¡ç®—) çš„ Transaction**
- è¿™ä¸ªç‰¹æ€§å¤ªé‡è¦äº†
```sql
tx_begin();
if (user1.balance < m) tx_abort();  // SQL
user1.balance -= m;  // SQL
user2.balance += m;  // SQL
tx_commit();
```

**ACID æ•°æ®åº“**
**å­¦è¿‡ã€Šæ“ä½œç³»ç»Ÿã€‹å°±å¾ˆå¥½ç†è§£äº†**
- ä¸€æŠŠå¤§é”ä¿å¹³å®‰çš„æ•ˆæœ
- å¤§è§„æ¨¡å¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½
- å®Œå…¨è‡ªåŠ¨çš„å´©æºƒå›å¤
    - åº”ç”¨æ•°æ®äº¤ç»™æ•°æ®åº“ = ä¸€åŠ³æ°¸é€¸; ç”šè‡³è¿˜å¯ä»¥ Hack

**å…³ç³»æ•°æ®åº“ï¼šæµ·é‡çš„å®ç°ä¼˜åŒ–**
- æŸ¥è¯¢ä¼˜åŒ– (rewriting)
- è¿æ¥ç´¢å¼• (B+ Tree)
- ç¼“å­˜ã€åˆ†åº“åˆ†è¡¨ã€å¹¶å‘æ§åˆ¶ã€è¯»å†™åˆ†ç¦»â€¦â€¦
    - åªè¦ä¸æ˜¯å¤§åˆ° â€œå›½æ°‘çº§â€ çš„åº”ç”¨ï¼Œæ•°æ®åº“éƒ½èƒ½æå®š

---
## 25.2 å…³ç³»æ•°æ®åº“ï¼šå®ç° ğŸŒ¶
**Databases v.s. Compilers**
**å®ç°æŸ¥è¯¢ = å®ç°ç¼–è¯‘ä¼˜åŒ– (è¯­ä¹‰ç­‰ä»·çš„ rewriting)**

**ä¸€ä¸ªè¶…çº§å¤æ‚çš„å¹¶å‘ç¨‹åº**
**æ¯ä¸ª SQL éƒ½æ“ä½œæ•°æ®åº“çš„ä¸€éƒ¨åˆ†**

**ä¾‹å­ï¼šSQLite**
- Android, iOS, macOS, Chrome, ... ä¸­å¹¿æ³›å†…åµŒäº† SQLite
    - Zero Configuration (å‘è¡Œç‰ˆè‡ªå¸¦ libsqlite3.soï¼›é€‚åˆ â€œå¹´è½»äººçš„ç¬¬ä¸€ä¸ªåº”ç”¨â€)

---
## Prompt: ä¸ºä»€ä¹ˆå…³ç³»å‹æ•°æ®åº“ä¸èƒ½ scale åˆ°å›½æ°‘çº§ä½“é‡çš„åº”ç”¨ï¼Ÿ
å…³ç³»å‹æ•°æ®åº“éš¾ä»¥æ‰©å±•åˆ°å›½æ°‘çº§ä½“é‡ï¼Œä¸»è¦åŸå› åŒ…æ‹¬ï¼š

1. æ°´å¹³æ‰©å±•å›°éš¾ï¼šå…³ç³»å‹æ•°æ®åº“å¤©ç„¶ä»¥ä¸€è‡´æ€§ï¼ˆACIDï¼‰ä¸ºæ ¸å¿ƒï¼Œæ•°æ®åˆ†è¡¨åˆ†åº“ï¼ˆshardingï¼‰å’Œè·¨èŠ‚ç‚¹äº‹åŠ¡å®ç°å¤æ‚ï¼Œå¯¼è‡´å¾ˆéš¾è¿›è¡Œé«˜æ•ˆçš„æ¨ªå‘æ‰©å±•ã€‚
2. æ€§èƒ½ç“¶é¢ˆï¼šéšç€æ•°æ®é‡å’Œå¹¶å‘ç”¨æˆ·æ•°å‰§å¢ï¼Œå•æœºæ•°æ®åº“åœ¨CPUã€å†…å­˜ã€ç£ç›˜å’Œç½‘ç»œç­‰èµ„æºä¸Šé¢ä¸´ç“¶é¢ˆï¼ŒæŸ¥è¯¢å’Œå†™å…¥é€Ÿåº¦ä¸‹é™ã€‚
3. é«˜å¯ç”¨ä¸å®¹ç¾å¤æ‚ï¼šå¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€æ•…éšœè‡ªåŠ¨æ¢å¤å’Œå¤šç‚¹å†™å…¥çš„å¤æ‚æ€§æé«˜ã€‚
4. æˆæœ¬é«˜æ˜‚ï¼šç”¨æ˜‚è´µçš„é«˜æ€§èƒ½æœåŠ¡å™¨æ¥å åŠ å…³ç³»å‹æ•°æ®åº“çš„èƒ½åŠ›ï¼Œæˆæœ¬è¿œé«˜äºå…¸å‹åˆ†å¸ƒå¼NoSQLè§£å†³æ–¹æ¡ˆã€‚

æ‰€ä»¥ï¼Œå›½æ°‘çº§å¤§è§„æ¨¡åº”ç”¨é€šå¸¸é‡‡ç”¨åˆ†å¸ƒå¼NoSQLæ•°æ®åº“æˆ–æ··åˆæ¶æ„ï¼Œä»¥è·å¾—æ›´å¥½çš„æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§ã€‚

---
## 25.3 ä¸ç”¨å…³ç³»çš„æ•°æ®åº“ ğŸŒ¶
**SQL â†’ NoSQL (NewSQL)**

**å¦‚æœè¦å®ç° â€œå›½æ°‘çº§â€ çš„åº”ç”¨ï¼Ÿ**
**â€œé€æ˜â€ çš„ SQL å°±æœ‰äº›å›°éš¾äº†**
```sql
SELECT *
FROM chat_records
WHERE (sender_id = @user_id1 AND receiver_id = @user_id2)
   OR (sender_id = @user_id2 AND receiver_id = @user_id1)
ORDER BY timestamp DESC
LIMIT 10
```
- æ­£ç¡®ï¼Œä½†å‹åŠ›ç»™åˆ°æ•°æ®åº“å¼•æ“
    - åˆ†åº“ã€åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€ç´¢å¼•ã€ç¼“å­˜ã€ä¼˜åŒ–â€¦â€¦
- **æ°¸è¿œæ— æ³•é¢„çŸ¥ç¨‹åºå‘˜ä¼šå†™å‡ºæ€æ ·çš„ query**
    - æä¾›äº†åŠŸèƒ½ = è¢«æ»¥ç”¨ â†’ Performance Bug
    - ä»»ä½• â€œSystemsâ€ éƒ½æ— æ³•é¿å…çš„ tech debt
        - ä¾‹å­ï¼šfork()

**è§£å†³åŠæ³•ï¼šåšå‡æ³•**
**æ›´å°‘çš„èƒ½åŠ›ï¼Œæ›´å¥½çš„æ€§èƒ½ã€æ›´é«˜çš„æ‰©å±•æ€§**
- Key/Value
    - ç®€å•ã€é«˜æ•ˆ (ç¼“å­˜ã€è®¡æ•°å™¨ã€é˜Ÿåˆ—)
- Document (JSON/XML/...)
    - NoSQL å®ç° â€œå›½æ°‘çº§â€ åº”ç”¨çš„ä¸»åŠ›
- Graph
- Column

**AI æ—¶ä»£**
- Vector ğŸ’¡

**Key-Value Store**
**è¿™ä¸ªå°±å¥½ scale å¤šäº†ï¼**
- ç»™ key åšä¸ª hash
- æ‰”åˆ°å¯¹åº”çš„ (å¤šå°æœºå™¨) ä¸Š
    - Append-only å†™åˆ° log
    - åˆ†å¸ƒå¼é«˜å¯é å°±å®Œæˆäº† (ç”šè‡³å¯ä»¥ä¸ persist)

**åº”ç”¨ç¨‹åºï¼šå…¨é  key ç®¡ç†æ•°æ®**
- user:{uid}
- user:{uid}:like_history (a list)
    - List æ”¯æŒ append/pop/range ç­‰æ“ä½œ
    - åº”ç”¨åœºæ™¯ï¼šğŸ  ä¸Šçš„ç‚¹èµ/æµè§ˆ/å†å²è®°å½•

**Redis: Everything is In-memory**
****Key-value**
GET, SET

**æ•°æ®ç»“æ„**
String, JSON, List, Set, Hash, Sorted Set, ..., Stream

**Query**
FT.SEARCH products "@price:[200 300] @category:misc"

**Transactions**
MULTI/WATCH/EXEC (ä¹Ÿæ”¯æŒæŒä¹…åŒ–)

**æŒä¹…åŒ–ï¼šNoSQL**
**æä¾› SQL çš„ä¸€ä¸ªå­é›†**

---
## 25.4 æ€»ç»“
ã€€ã€€***Take-away Messages***: åœ¨æ“ä½œç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›çš„æ–‡ä»¶ã€ç›®å½•ã€ç½‘ç»œ API ä¸Šï¼Œå¼€å‘è€…å¯ä»¥è‡ªç”±åœ°åˆ›å»ºæ›´å¤šã€æ›´å¤æ‚ã€æ›´å¯é çš„ç³»ç»Ÿã€‚æˆ‘ä»¬çœ‹åˆ°äº†å…³ç³»æ•°æ®åº“çš„å…´èµ·ï¼Œçœ‹åˆ°äº†äº‘è®¡ç®—æ—¶ä»£ä¸‹ NoSQL çš„ç¹è£ï¼Œå’Œä»Šå¤©çš„ AI æ—¶ä»£â€”â€”åœ¨è¿™å‡ æ³¢æµªæ½®ä¹‹é—´ï¼Œè™½ç„¶æ“ä½œç³»ç»Ÿå†…æ ¸çš„å®ç°å‘ç”Ÿäº†å·¨å¤§çš„å˜åŒ–ï¼Œä½†æ“ä½œç³»ç»Ÿçš„ API ç›¸å½“æƒŠäººåœ°ç¨³å®šï¼Œè¿™ç§ â€œç¨³å®šæ€§â€ æ”¯æ’‘äº†åº”ç”¨ç”Ÿæ€çš„ç¹è£ï¼Œè¿™ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿä½œä¸º â€œå¹³å°â€ çš„ä½¿å‘½ã€‚